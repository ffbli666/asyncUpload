<html>
<head>
    <meta http-equiv='content-type' content='text/html; charset=utf-8'>
    <title></title>
    <link href='../css/bootstrap.min.css' rel='stylesheet'>
    <style>
        .hiden {
            display: none;
        }

        .progress {
            margin-bottom: 0px
        }

        .progress_container {
            width:  500px;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-height: 28px;
        }

        .progress_container .item  {
            padding: 4px;
            display: flex;
            display: -webkit-box;
        }

        .progress_container .filename {
            flex:1;
            -webkit-box-flex: 1;
        }

        .progress_container .progress_area {
            width: 200px;
            padding: 0 10px;
        }

        .progress_container .cancel_area {
            width:71px;
        }
    </style>
</head>
<body>
<div class='container-fluid'>
    <h1>Demo</h1>
    <div class='row'>
        <div class='col-xs-6'>
            <h3>Upload </h3>
            <button type='button' name='upload' id='upload' class='btn btn-default'>Upload</button>
            <button type='button' name='upload' id='upload_image' class='btn btn-default'>Upload Image</button>
            <span class='status'></span>
            <br><br>
            <div class='progress_container'>
                <div class='item'>
                    <div class='filename'>filename</div>
                    <div class='progress_area'>
                        <div class='progress'>
                            <div class='progress-bar'>
                                <span class='progress-value'></span>
                            </div>
                        </div>
                    </div>
                    <div class='cancel_area'><a class='cancel'>Cancel</a></div>
                </div>
            </div>
        </div>
        <div class='col-xs-6'>
            <h3>Sever Response</h3>
            <ul class='response'>

            </ul>
        </div>
    </div>
</div>
</body>
</html>
<script>
'use strict';
var DefaultFileUpload = function(customize) {
    return {
        check: function (file) {return true},
        progress: function (e) {},
        success: function (response) {},
        error: function (e) {}
    };
};

var AsyncUpload = function (selector, options) {
    var elements = document.querySelectorAll(selector);
    if (elements.length == 0) {
        throw new Error('Can not select any element');
    }

    var settings = {
        url: options.url || undefined,
        accept: options.accept || undefined,
        multiple: options.multiple || false,
        FileUpload: options.FileUpload || DefaultFileUpload,
        //checkFiles: options.checkFiles || function() {return true},
        // preSend: options.preSend || function() {return true},
        // progress: options.progress || function() {},
        // success: options.success || function() {},
        // error: options.error || function() {}
    };

    if (!options.url) {
        throw new Error('Need url!');
    }

    for(var i=0; i<elements.length; i++) {
        var element = elements[i];
        var input = document.createElement('input');
        input.setAttribute('type', 'file');
        element.onclick = function() {
            input.click();
        };
        element.input = input;

        if (settings.multiple) {
            input.multiple = 'multiple';
        }
        if (settings.accept) {
            input.accept = settings.accept;
        }
        input.onchange = function () {
            /*
                這是個特殊解法
                因為 fileUpload 是使用 var 宣告
                而 javascript 在 = 時，如果是 object 會使用 call by reference
                故在 async function 內(例如 xhr.upload.onprogress) 都會參考到最後一個 fileUpload

                最好的解法是使用 let 宣告，但有許多瀏覽器沒有支援 http://caniuse.com/#search=let
                所以只好使用 forEach 令其 scope 是獨立的
                input.files 沒有 forEach，所以丟入 array 產生 forEach
            */
            var fileList = [];
            for(var j=0; j<input.files.length; j++) {
                fileList.push(input.files[j]);
            }

            fileList.forEach(function(file) {
                //create fomedata
                var formData = new FormData();
                //var file = input.files[j];
                formData.append(element.name, file);

                var xhr = new XMLHttpRequest();
                xhr.open('POST', settings.url, true);
                file.xhr = xhr;
                //need use let, but firefox not support
                var fileUpload = new settings.FileUpload();
                if (typeof fileUpload.check === 'function') {
                    fileUpload.check.call(xhr, file);
                }

                if (typeof fileUpload.progress === 'function') {
                    xhr.upload.onprogress = function(e) {
                        fileUpload.progress.call(xhr, e);
                    };
                }

                if (typeof fileUpload.success === 'function') {
                    xhr.onload = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            fileUpload.success.call(xhr, xhr.response);
                        }
                    };
                }

                if (typeof fileUpload.error === 'function') {
                    xhr.onerror = function(e) {
                        fileUpload.error.call(xhr, e);
                    };
                }
                xhr.send(formData);
            });
        };
    };
}

var FileUpload = function() {
    var container = document.querySelector('.progress_container');
    var template = container.querySelector('.item').cloneNode(true);
    container.innerHTML = '';
    return function () {
        var that = this;
        var tmp = template.cloneNode(true);
        var check = function(file) {
            tmp.querySelector('.filename').innerHTML = file.name;
            tmp.querySelector('.cancel').onclick = function() {
                file.xhr.abort();
            };
            container.appendChild(tmp);
            return true;
        };
        var progress = function(e) {
            var percentComplete = parseInt((e.loaded / e.total) * 100);
            tmp.querySelector('.progress-bar').style.width = percentComplete + '%';
            tmp.querySelector('.progress-value').innerHTML = percentComplete + '%';
        };

        var success = function(response) {
            document.querySelector('.response').innerHTML += '<li>' + response + '</li>';
        };

        return  {
            check: check,
            progress: progress,
            success: success
        };
    };
};

var upload = new AsyncUpload('#upload', {
    url: '../upload_submit.php',
    multiple: true,
    //FileUpload: new FileUpload(),
});
</script>
